<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Pa Gerrys Mart - Supermarket POS System">
    <meta name="theme-color" content="#2c3e50">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Pa Gerrys Mart">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè™</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxOTIgMTkyIj48cGF0aCBmaWxsPSIjMjNjM2U1MCIgZD0iTTE0OCAxMjBjMC0xNy43IDE0LjMtMzIgMzItMzJzMzIgMTQuMyAzMiAzMmMwIDguOC0zLjYgMTYuNy05LjQgMjIuNmwtMTIuMiAxMi4yYy0yLjgtMi44LTYuNi00LjQtMTAuNi00LjRzLTcuOCAxLjYtMTAuNiA0LjRsLTEyLjItMTIuMmMtNS44LTUuOC05LjQtMTMuOC05LjQtMjIuNiAwLTE3LjcgMTQuMy0zMiAzMi0zMnMzMiAxNC4zIDMyIDMyYzAgOC44LTMuNiAxNi43LTkuNCAyMi42bDQuNiA0LjZjNS44IDUuOCAxNS4yIDUuOCAyMXMtNS44IDE1LjItNS44IDIxbC00LjYgNC42YzUuOCA1LjggMTMuOCA5LjQgMjIuNiA5LjQgMTcuNyAwIDMyLTE0LjMgMzItMzJ6TTE0OCAxMjBjMC04LjgtNy4yLTE2LTE2LTE2cy0xNiA3LjItMTYgMTYgNy4yIDE2IDE2IDE2IDE2LTcuMiAxNi0xNnoiLz48L3N2Zz4=">
    
    <!-- UPDATE: Link to external manifest file for PWA -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlBhIEdlcnJ5cyBNYXJ0IiwKICAic2hvcnRfbmFtZSI6ICJQYSBHZXJyeXMiLAogICJkZXNjcmlwdGlvbiI6ICJTdXBlcm1hcmtldCBQT1MgU3lzdGVtIiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMmMzZTUwIiwKICAidGhlbWVfY29sb3IiOiAiIzJjM2U1MCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMll6QjRiV3h1Y3owaWFIVFhNWEIwTlM5eWJVNU5aV0p2YjJ4b1lYSmhiR3c2T1RZNU5ETTNNak0xTnpBNE1qVTJNVFUyTmpVNU1qQXdNakEwT0RZNU5UQXhNakU0T2pVMk9EazJNVGt4T1E9PSIsCiAgICAgICJzaXplcyI6ICIxNDR4MTQ0IiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">
    
    <title>Pa Gerrys Mart - POS System</title>
    
    <!-- FIX 1: Added Font Awesome CDN to fix icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Rest of your CSS styles -->
    <style>
        :root { 
            --primary-color: #2c3e50; 
            --secondary-color: #3498db; 
            --accent-color: #e74c3c; 
            --success-color: #27ae60; 
            --light-color: #ecf0f1; 
            --dark-color: #2c3e50; 
            --gray-color: #95a5a6; 
            --warning-color: #f39c12; 
        } 
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        } 
        
        body { 
            background-color: #f5f7fa; 
            color: var(--dark-color); 
            overflow-x: hidden; 
        } 
        
        .container { 
            display: flex; 
            min-height: 100vh; 
        } 
        
        .sidebar { 
            width: 260px; 
            background-color: var(--primary-color); 
            color: white; 
            padding: 20px 0; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); 
            position: fixed; 
            height: 100vh; 
            overflow-y: auto; 
            z-index: 1000; 
            transition: transform 0.3s ease; 
        } 
        
        .sidebar.collapsed { 
            transform: translateX(-100%); 
        } 
        
        .logo { 
            text-align: center; 
            padding: 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            margin-bottom: 20px; 
        } 
        
        .logo h1 { 
            font-size: 1.8rem; 
            margin-bottom: 5px; 
        } 
        
        .logo p { 
            color: var(--gray-color); 
            font-size: 0.9rem; 
        } 
        
        .nav-menu { 
            list-style: none; 
        } 
        
        .nav-item { 
            margin-bottom: 5px; 
        } 
        
        .nav-link { 
            display: flex; 
            align-items: center; 
            padding: 12px 20px; 
            color: white; 
            text-decoration: none; 
            transition: all 0.3s; 
        } 
        
        .nav-link:hover, .nav-link.active { 
            background-color: rgba(255,255,255,0.1); 
            border-left: 3px solid var(--secondary-color); 
        } 
        
        .nav-link i { 
            margin-right: 10px; 
            width: 20px; 
            text-align: center; 
        } 
        
        .main-content { 
            flex: 1; 
            padding: 20px; 
            margin-left: 260px; 
            overflow-y: auto; 
            transition: margin-left 0.3s ease; 
        } 
        
        .main-content.expanded { 
            margin-left: 0; 
        } 
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            padding-bottom: 15px; 
            border-bottom: 1px solid #ddd; 
        } 
        
        .header h2 { 
            font-size: 1.8rem; 
            color: var(--primary-color); 
        } 
        
        .user-info { 
            display: flex; 
            align-items: center; 
        } 
        
        .user-info .user-icon { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            background-color: var(--secondary-color); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-right: 10px; 
            color: white; 
        } 
        
        .user-info span { 
            font-weight: 500; 
        } 
        
        .user-role { 
            background-color: var(--secondary-color); 
            color: white; 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-size: 0.75rem; 
            margin-left: 8px; 
        } 
        
        .logout-btn { 
            background: var(--accent-color); 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-left: 15px; 
            transition: background 0.3s; 
        } 
        
        .logout-btn:hover { 
            background: #c0392b; 
        } 
        
        .mobile-menu-btn { 
            display: none; 
            background: var(--primary-color); 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 1.2rem; 
            position: fixed; 
            top: 20px; 
            left: 20px; 
            z-index: 1001; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        } 
        
        .pos-container { 
            display: grid; 
            grid-template-columns: 1fr 400px; 
            gap: 20px; 
        } 
        
        .products-section { 
            background: white; 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        } 
        
        .section-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        } 
        
        .section-header h3 { 
            font-size: 1.3rem; 
            color: var(--dark-color); 
        } 
        
        .search-bar { 
            display: flex; 
            margin-bottom: 20px; 
        } 
        
        .search-bar input { 
            flex: 1; 
            padding: 12px 15px; 
            border: 1px solid #ddd; 
            border-radius: 4px 0 0 4px; 
            font-size: 1rem; 
        } 
        
        .search-bar button { 
            background: var(--secondary-color); 
            color: white; 
            border: none; 
            padding: 0 15px; 
            border-radius: 0 4px 4px 0; 
            cursor: pointer; 
        } 
        
        .products-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 15px; 
        } 
        
        .product-card { 
            border: 1px solid #eee; 
            border-radius: 8px; 
            padding: 15px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s; 
        } 
        
        .product-card:hover { 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            transform: translateY(-3px); 
        } 
        
        .product-card .product-img { 
            height: 80px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 10px; 
            background-color: #f9f9f9; 
            border-radius: 4px; 
        } 
        
        .product-card .product-img i { 
            font-size: 2.5rem; 
            color: var(--secondary-color); 
        } 
        
        .product-card h4 { 
            font-size: 0.9rem; 
            margin-bottom: 5px; 
        } 
        
        .product-card .price { 
            font-weight: 700; 
            color: var(--accent-color); 
        } 
        
        .product-card .stock { 
            font-size: 0.8rem; 
            color: var(--gray-color); 
        } 
        
        .product-card .expiry-warning { 
            font-size: 0.75rem; 
            color: var(--warning-color); 
            margin-top: 5px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        } 
        
        .product-card .expiry-warning i { 
            margin-right: 4px; 
        } 
        
        .cart-section { 
            background: white; 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            height: fit-content; 
        } 
        
        .cart-items { 
            margin-bottom: 20px; 
            max-height: 400px; 
            overflow-y: auto; 
        } 
        
        .cart-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px 0; 
            border-bottom: 1px solid #eee; 
        } 
        
        .cart-item:last-child { 
            border-bottom: none; 
        } 
        
        .cart-item-info { 
            flex: 1; 
        } 
        
        .cart-item-name { 
            font-weight: 500; 
        } 
        
        .cart-item-price { 
            color: var(--gray-color); 
            font-size: 0.9rem; 
        } 
        
        .cart-item-qty { 
            display: flex; 
            align-items: center; 
            margin-top: 5px; 
        } 
        
        .cart-item-qty button { 
            background: #f0f0f0; 
            border: none; 
            width: 24px; 
            height: 24px; 
            border-radius: 4px; 
            cursor: pointer; 
        } 
        
        .cart-item-qty input { 
            width: 40px; 
            text-align: center; 
            border: 1px solid #eee; 
            margin: 0 5px; 
        } 
        
        .cart-item-total { 
            font-weight: 700; 
            color: var(--dark-color); 
        } 
        
        .cart-summary { 
            border-top: 1px solid #eee; 
            padding-top: 15px; 
            margin-top: 15px; 
        } 
        
        .summary-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
        } 
        
        .summary-row.total { 
            font-weight: 700; 
            font-size: 1.1rem; 
            color: var(--dark-color); 
            border-top: 1px solid #eee; 
            padding-top: 10px; 
        } 
        
        .cart-actions { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-top: 20px; 
        } 
        
        .btn { 
            padding: 12px 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: 500; 
            text-align: center; 
            transition: all 0.3s; 
            position: relative; 
            overflow: hidden; 
        } 
        
        .btn-primary { 
            background: var(--secondary-color); 
            color: white; 
        } 
        
        .btn-primary:hover { 
            background: #2980b9; 
        } 
        
        .btn-success { 
            background: var(--success-color); 
            color: white; 
        } 
        
        .btn-success:hover { 
            background: #229954; 
        } 
        
        .btn-danger { 
            background: var(--accent-color); 
            color: white; 
        } 
        
        .btn-danger:hover { 
            background: #c0392b; 
        } 
        
        .btn-outline { 
            background: transparent; 
            border: 1px solid var(--gray-color); 
            color: var(--dark-color); 
        } 
        
        .btn-outline:hover { 
            background: #f0f0f0; 
        } 
        
        .btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
        } 
        
        .btn.loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 8px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        .inventory-container { 
            background: white; 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            position: relative;
        } 
        
        .inventory-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        } 
        
        .inventory-value { 
            background: #f8f9fa; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        } 
        
        .inventory-value h3 { 
            margin: 0; 
            color: var(--dark-color); 
        } 
        
        .inventory-value .value { 
            font-size: 1.5rem; 
            font-weight: 700; 
            color: var(--success-color); 
        } 
        
        .inventory-table { 
            width: 100%; 
            border-collapse: collapse; 
        } 
        
        .inventory-table th, .inventory-table td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid #eee; 
        } 
        
        .inventory-table th { 
            background-color: #f8f9fa; 
            font-weight: 600; 
            color: var(--dark-color); 
        } 
        
        .inventory-table tr:hover { 
            background-color: #f8f9fa; 
        } 
        
        .inventory-table tr.expiring-soon { 
            background-color: #fff8e1; 
        } 
        
        .inventory-table tr.expired { 
            background-color: #ffebee; 
        } 
        
        .stock-badge { 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 0.8rem; 
            font-weight: 500; 
        } 
        
        .stock-high { 
            background-color: #d4edda; 
            color: #155724; 
        } 
        
        .stock-medium { 
            background-color: #fff3cd; 
            color: #856404; 
        } 
        
        .stock-low { 
            background-color: #f8d7da; 
            color: #721c24; 
        } 
        
        .expiry-badge { 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 0.8rem; 
            font-weight: 500; 
        } 
        
        .expiry-good { 
            background-color: #d4edda; 
            color: #155724; 
        } 
        
        .expiry-warning { 
            background-color: #fff3cd; 
            color: #856404; 
        } 
        
        .expiry-expired { 
            background-color: #f8d7da; 
            color: #721c24; 
        } 
        
        .action-buttons { 
            display: flex; 
            gap: 5px; 
        } 
        
        .action-buttons button { 
            padding: 5px 8px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            color: white; 
        } 
        
        .btn-edit { 
            background: var(--secondary-color); 
        } 
        
        .btn-delete { 
            background: var(--accent-color); 
        } 
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.5); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
        } 
        
        .modal-content { 
            background: white; 
            border-radius: 8px; 
            width: 90%; 
            max-width: 500px; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            position: relative;
        } 
        
        .modal-header { 
            padding: 15px 20px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        } 
        
        .modal-header h3 { 
            margin: 0; 
            color: var(--dark-color); 
        } 
        
        .modal-close { 
            background: none; 
            border: none; 
            font-size: 1.5rem; 
            cursor: pointer; 
            color: var(--gray-color); 
        } 
        
        .modal-body { 
            padding: 20px; 
        } 
        
        .form-group { 
            margin-bottom: 15px; 
        } 
        
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 500; 
        } 
        
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-size: 1rem; 
        } 
        
        .modal-footer { 
            padding: 15px 20px; 
            border-top: 1px solid #eee; 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
        } 
        
        .receipt { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            max-width: 400px; 
            margin: 0 auto; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            font-family: 'Courier New', monospace; 
        } 
        
        .receipt-header { 
            text-align: center; 
            margin-bottom: 20px; 
            border-bottom: 1px dashed #ccc; 
            padding-bottom: 10px; 
        } 
        
        .receipt-header h2 { 
            margin-bottom: 5px; 
        } 
        
        .receipt-header p { 
            margin: 2px 0; 
            font-size: 0.9rem; 
        } 
        
        .receipt-items { 
            margin-bottom: 20px; 
        } 
        
        .receipt-item { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 8px; 
        } 
        
        .receipt-footer { 
            border-top: 1px dashed #ccc; 
            padding-top: 10px; 
        } 
        
        .receipt-total { 
            display: flex; 
            justify-content: space-between; 
            font-weight: 700; 
            margin-bottom: 5px; 
        } 
        
        .receipt-actions { 
            margin-top: 20px; 
            display: flex; 
            gap: 10px; 
        } 
        
        .notification { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            padding: 15px 20px; 
            border-radius: 4px; 
            color: white; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            z-index: 2000; 
            display: flex; 
            align-items: center; 
            transform: translateX(150%); 
            transition: transform 0.3s ease-out; 
        } 
        
        .notification.show { 
            transform: translateX(0); 
        } 
        
        .notification.success { 
            background: var(--success-color); 
        } 
        
        .notification.error { 
            background: var(--accent-color); 
        } 
        
        .notification.warning { 
            background: var(--warning-color); 
        } 
        
        .notification.info { 
            background: var(--secondary-color); 
        } 
        
        .notification i { 
            margin-right: 10px; 
            font-size: 1.2rem; 
        } 
        
        .login-container { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
        } 
        
        .login-card { 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            width: 400px; 
            padding: 40px; 
        } 
        
        .login-header { 
            text-align: center; 
            margin-bottom: 30px; 
        } 
        
        .login-header h1 { 
            color: var(--primary-color); 
            margin-bottom: 10px; 
        } 
        
        .login-header p { 
            color: var(--gray-color); 
        } 
        
        .login-tabs { 
            display: flex; 
            margin-bottom: 20px; 
            border-bottom: 1px solid #eee; 
        } 
        
        .login-tab { 
            flex: 1; 
            padding: 10px; 
            text-align: center; 
            cursor: pointer; 
            font-weight: 500; 
        } 
        
        .login-tab.active { 
            border-bottom: 2px solid var(--secondary-color); 
            color: var(--secondary-color); 
        } 
        
        .tab-content { 
            display: none; 
        } 
        
        .tab-content.active { 
            display: block; 
        } 
        
        .login-btn { 
            width: 100%; 
            padding: 12px; 
            background: var(--secondary-color); 
            color: white; 
            border: none; 
            border-radius: 4px; 
            font-size: 1rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: background 0.3s; 
        } 
        
        .login-btn:hover { 
            background: #2980b9; 
        } 
        
        .login-error { 
            color: var(--accent-color); 
            margin-top: 15px; 
            text-align: center; 
            display: none; 
        } 
        
        .user-management { 
            background: white; 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
        } 
        
        .user-info-card { 
            background: #f8f9fa; 
            border-radius: 8px; 
            padding: 20px; 
            margin-bottom: 20px; 
        } 
        
        .user-info-card h3 { 
            margin-bottom: 15px; 
        } 
        
        .user-info-card .info-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
            padding-bottom: 10px; 
            border-bottom: 1px solid #eee; 
        } 
        
        .user-info-card .info-row:last-child { 
            border-bottom: none; 
            margin-bottom: 0; 
            padding-bottom: 0; 
        } 
        
        .user-info-card .info-label { 
            font-weight: 600; 
            color: var(--dark-color); 
        } 
        
        .user-info-card .info-value { 
            color: var(--gray-color); 
        } 
        
        .empty-state { 
            text-align: center; 
            padding: 40px; 
            color: var(--gray-color); 
        } 
        
        .empty-state i { 
            font-size: 3rem; 
            margin-bottom: 15px; 
            color: #ddd; 
        } 
        
        .empty-state h3 { 
            margin-bottom: 10px; 
        } 
        
        .deleted-sales-section { 
            margin-top: 30px; 
            padding-top: 20px; 
            border-top: 1px dashed #ddd; 
        } 
        
        .deleted-sales-section h4 { 
            color: var(--accent-color); 
            margin-bottom: 15px; 
            display: flex; 
            align-items: center; 
        } 
        
        .deleted-sales-section h4 i { 
            margin-right: 8px; 
        } 
        
        .deleted-sales-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
        } 
        
        .deleted-sales-table th, .deleted-sales-table td { 
            padding: 10px 15px; 
            text-align: left; 
            border-bottom: 1px solid #eee; 
        } 
        
        .deleted-sales-table th { 
            background-color: #f8f9fa; 
            font-weight: 600; 
            color: var(--dark-color); 
        } 
        
        .deleted-sales-table tr { 
            background-color: #f9f9f9; 
        } 
        
        .deleted-badge { 
            background-color: var(--accent-color); 
            color: white; 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-size: 0.75rem; 
            font-weight: 500; 
        } 
        
        .daily-report-controls { 
            background: #f8f9fa; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            flex-wrap: wrap; 
        } 
        
        .daily-report-controls label { 
            font-weight: 600; 
            color: var(--dark-color); 
        } 
        
        .daily-report-controls input { 
            padding: 8px 12px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-size: 1rem; 
        } 
        
        .daily-report-controls button { 
            padding: 8px 15px; 
            background: var(--secondary-color); 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        } 
        
        .daily-report-controls button:hover { 
            background: #2980b9; 
        } 
        
        .daily-summary { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px; 
        } 
        
        .daily-summary-card { 
            background: white; 
            border-radius: 8px; 
            padding: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            text-align: center; 
        } 
        
        .daily-summary-card .value { 
            font-size: 1.8rem; 
            font-weight: 700; 
            color: var(--dark-color); 
            margin-bottom: 5px; 
        } 
        
        .daily-summary-card .label { 
            color: var(--gray-color); 
            font-size: 0.9rem; 
        } 
        
        .daily-sales-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
        } 
        
        .daily-sales-table th, .daily-sales-table td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid #eee; 
        } 
        
        .daily-sales-table th { 
            background-color: #f8f9fa; 
            font-weight: 600; 
            color: var(--dark-color); 
        } 
        
        .daily-sales-table tr:hover { 
            background-color: #f8f9fa; 
        } 
        
        .report-section { 
            margin-bottom: 30px; 
        } 
        
        .report-section h3 { 
            margin-bottom: 15px; 
            color: var(--dark-color); 
            display: flex; 
            align-items: center; 
        } 
        
        .report-section h3 i { 
            margin-right: 8px; 
            color: var(--secondary-color); 
        } 
        
        .no-data { 
            text-align: center; 
            padding: 20px; 
            color: var(--gray-color); 
            font-style: italic; 
        } 
        
        .install-btn { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: var(--success-color); 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 50px; 
            font-weight: 600; 
            cursor: pointer; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            z-index: 999; 
            transition: all 0.3s ease; 
        } 
        
        .install-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 16px rgba(0,0,0,0.2); 
        } 
        
        .install-btn i { 
            font-size: 1.2rem; 
        } 
        
        .offline-indicator { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            background: var(--warning-color); 
            color: white; 
            text-align: center; 
            padding: 10px; 
            font-weight: 600; 
            display: none; 
            z-index: 1002; 
        } 
        
        .offline-indicator.show { 
            display: block; 
        } 
        
        .sync-status { 
            position: fixed; 
            bottom: 20px; 
            left: 20px; 
            background: var(--success-color); 
            color: white; 
            padding: 8px 15px; 
            border-radius: 4px; 
            font-size: 0.8rem; 
            display: none; 
            z-index: 999; 
        } 
        
        .sync-status.show { 
            display: block; 
        } 
        
        .sync-status.syncing { 
            background: var(--warning-color); 
        } 
        
        .sync-status.error { 
            background: var(--accent-color); 
        } 
        
        .users-container { 
            background: white; 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            margin-top: 20px; 
        } 
        
        .users-container h3 { 
            margin-bottom: 15px; 
            color: var(--dark-color); 
        } 
        
        .users-list { 
            display: grid; 
            gap: 15px; 
        } 
        
        .user-card { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 8px; 
        } 
        
        .user-card .user-info { 
            display: flex; 
            flex-direction: column; 
        } 
        
        .user-card .user-info strong { 
            margin-bottom: 5px; 
        } 
        
        .user-card .user-info span { 
            color: var(--gray-color); 
            font-size: 0.9rem; 
        } 
        
        .role-badge { 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 0.75rem; 
            font-weight: 500; 
            margin-top: 5px; 
            display: inline-block; 
        } 
        
        .role-badge.admin { 
            background-color: #d4edda; 
            color: #155724; 
        } 
        
        .role-badge.cashier { 
            background-color: #d1ecf1; 
            color: #0c5460; 
        } 
        
        @media (max-width: 992px) { 
            .pos-container { 
                grid-template-columns: 1fr; 
            } 
            .cart-section { 
                order: -1; 
            } 
        } 
        
        @media (max-width: 768px) { 
            .mobile-menu-btn { 
                display: block; 
            } 
            .sidebar { 
                transform: translateX(-100%); 
            } 
            .sidebar.active { 
                transform: translateX(0); 
            } 
            .main-content { 
                margin-left: 0; 
            } 
            .nav-menu { 
                display: flex; 
                overflow-x: auto; 
            } 
            .nav-item { 
                margin-bottom: 0; 
            } 
            .nav-link { 
                padding: 10px; 
                flex-direction: column; 
                align-items: center; 
                font-size: 0.8rem; 
            } 
            .nav-link i { 
                margin-right: 0; 
                margin-bottom: 5px; 
            } 
            .daily-report-controls { 
                flex-direction: column; 
                align-items: flex-start; 
            } 
            .daily-summary { 
                grid-template-columns: 1fr; 
            } 
        } 
        
        @media (max-width: 576px) { 
            .products-grid { 
                grid-template-columns: repeat(2, 1fr); 
            } 
            .cart-actions { 
                grid-template-columns: 1fr; 
            } 
            .login-card { 
                width: 90%; 
                padding: 30px 20px; 
            } 
            .header { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 15px; 
            } 
            .section-header { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 10px; 
            } 
            .inventory-header { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 10px; 
            } 
            .modal-content { 
                width: 95%; 
                margin: 20px; 
            } 
        }
    </style>
</head>
<body>
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-indicator">
        <i class="fas fa-wifi-slash"></i> You are currently offline. Some features may be limited.
    </div>
    
    <!-- Sync Status Indicator -->
    <div id="sync-status" class="sync-status">
        <i class="fas fa-sync"></i> Syncing data...
    </div>
    
    <!-- Mobile Menu Button -->
    <button id="mobile-menu-btn" class="mobile-menu-btn">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- PWA Install Button -->
    <button id="install-btn" class="install-btn" style="display: none;">
        <i class="fas fa-download"></i> Install App
    </button>
    
    <!-- Login Page -->
    <div id="login-page" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>Pa Gerrys Mart</h1>
                <p>Alatishe, Ibeju Lekki, Lagos State, Nigeria</p>
            </div>
            
            <div class="login-tabs">
                <div class="login-tab active" data-tab="login">Login</div>
                <div class="login-tab" data-tab="register" id="register-tab">Register</div>
            </div>
            
            <!-- Login Tab -->
            <div id="login-tab" class="tab-content active">
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="login-btn" id="login-submit-btn">Login</button>
                    <div id="login-error" class="login-error">Invalid email or password. Please try again.</div>
                </form>
            </div>
            
            <!-- Register Tab -->
            <div id="register-tab-content" class="tab-content">
                <form id="register-form">
                    <div class="form-group">
                        <label for="register-name">Full Name</label>
                        <input type="text" id="register-name" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">Password</label>
                        <input type="password" id="register-password" placeholder="Create a password" required>
                    </div>
                    <div class="form-group">
                        <label for="register-confirm-password">Confirm Password</label>
                        <input type="password" id="register-confirm-password" placeholder="Confirm your password" required>
                    </div>
                    <div class="form-group">
                        <label for="register-role">Role</label>
                        <select id="register-role" required>
                            <option value="">Select Role</option>
                            <option value="admin">Admin</option>
                            <option value="cashier">Cashier</option>
                        </select>
                    </div>
                    <button type="submit" class="login-btn" id="register-submit-btn">Register</button>
                    <div id="register-error" class="login-error">Registration failed. Please try again.</div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Main Application -->
    <div id="app-container" class="container" style="display: none;">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="logo">
                <h1>Pa Gerrys Mart</h1>
                <p>Supermarket POS</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-page="pos">
                        <i class="fas fa-cash-register"></i>
                        <span>Point of Sale</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="inventory">
                        <i class="fas fa-boxes"></i>
                        <span>Inventory</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="reports">
                        <i class="fas fa-chart-line"></i>
                        <span>Sales Reports</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="account">
                        <i class="fas fa-user-cog"></i>
                        <span>My Account</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <h2 id="page-title">Point of Sale</h2>
                <div class="user-info">
                    <div class="user-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <span id="current-user">User</span>
                    <span id="user-role" class="user-role">Admin</span>
                    <button class="logout-btn" id="logout-btn">Logout</button>
                </div>
            </div>
            
            <!-- POS Page -->
            <div id="pos-page" class="page-content">
                <div class="pos-container">
                    <div class="products-section">
                        <div class="section-header">
                            <h3>Products</h3>
                            <button class="btn btn-primary" id="add-product-btn">
                                <i class="fas fa-plus"></i> Add Product
                            </button>
                        </div>
                        
                        <div class="search-bar">
                            <input type="text" id="product-search" placeholder="Search products or scan barcode...">
                            <button id="search-btn"><i class="fas fa-search"></i></button>
                        </div>
                        
                        <div class="products-grid" id="products-grid">
                            <div class="empty-state">
                                <i class="fas fa-box-open"></i>
                                <h3>No Products Added Yet</h3>
                                <p>Click "Add Product" to start adding your inventory</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cart-section">
                        <h3>Current Sale</h3>
                        
                        <div class="cart-items" id="cart-items">
                            <p style="text-align: center; color: #999; padding: 20px;">No items in cart</p>
                        </div>
                        
                        <div class="cart-summary">
                            <div class="summary-row total">
                                <span>Total:</span>
                                <span id="total">‚Ç¶0.00</span>
                            </div>
                        </div>
                        
                        <div class="cart-actions">
                            <button class="btn btn-outline" id="clear-cart-btn">Clear</button>
                            <button class="btn btn-success" id="complete-sale-btn">Complete Sale</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Inventory Page -->
            <div id="inventory-page" class="page-content" style="display: none;">
                <div class="inventory-container">
                    <div class="loading-overlay" id="inventory-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="inventory-header">
                        <h3>Inventory Management</h3>
                        <button class="btn btn-primary" id="add-inventory-btn">
                            <i class="fas fa-plus"></i> Add New Product
                        </button>
                    </div>
                    
                    <div class="inventory-value">
                        <h3>Total Inventory Value</h3>
                        <div class="value" id="inventory-total-value">‚Ç¶0.00</div>
                    </div>
                    
                    <div class="search-bar">
                        <input type="text" id="inventory-search" placeholder="Search inventory...">
                        <button id="inventory-search-btn"><i class="fas fa-search"></i></button>
                    </div>
                    
                    <div class="inventory-table-container">
                        <table class="inventory-table">
                            <thead>
                                <tr>
                                    <th>Product ID</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Expiry Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body">
                                <tr>
                                    <td colspan="8" style="text-align: center;">No products in inventory</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Reports Page -->
            <div id="reports-page" class="page-content" style="display: none;">
                <div class="inventory-container">
                    <div class="loading-overlay" id="reports-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                    </div>
                    <h3>Sales Reports</h3>
                    
                    <!-- Daily Report Controls -->
                    <div class="daily-report-controls">
                        <label for="report-date">Select Date:</label>
                        <input type="date" id="report-date" value="">
                        <button id="generate-report-btn">Generate Report</button>
                    </div>
                    
                    <!-- Overall Summary -->
                    <div class="report-section">
                        <h3><i class="fas fa-chart-bar"></i> Overall Summary</h3>
                        <div class="sales-summary" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div class="summary-card" style="background: #f8f9fa; border-radius: 8px; padding: 15px; text-align: center;">
                                <div class="value" style="font-size: 1.8rem; font-weight: 700; color: var(--dark-color); margin-bottom: 5px;" id="report-total-sales">‚Ç¶0.00</div>
                                <div class="label" style="color: var(--gray-color); font-size: 0.9rem;">Total Sales</div>
                            </div>
                            <div class="summary-card" style="background: #f8f9fa; border-radius: 8px; padding: 15px; text-align: center;">
                                <div class="value" style="font-size: 1.8rem; font-weight: 700; color: var(--dark-color); margin-bottom: 5px;" id="report-transactions">0</div>
                                <div class="label" style="color: var(--gray-color); font-size: 0.9rem;">Transactions</div>
                            </div>
                            <div class="summary-card" style="background: #f8f9fa; border-radius: 8px; padding: 15px; text-align: center;">
                                <div class="value" style="font-size: 1.8rem; font-weight: 700; color: var(--dark-color); margin-bottom: 5px;" id="report-items-sold">0</div>
                                <div class="label" style="color: var(--gray-color); font-size: 0.9rem;">Items Sold</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Daily Report Section -->
                    <div class="report-section">
                        <h3><i class="fas fa-calendar-day"></i> Daily Report</h3>
                        <div class="daily-summary" id="daily-summary">
                            <div class="daily-summary-card">
                                <div class="value" id="daily-total-sales">‚Ç¶0.00</div>
                                <div class="label">Daily Sales</div>
                            </div>
                            <div class="daily-summary-card">
                                <div class="value" id="daily-transactions">0</div>
                                <div class="label">Daily Transactions</div>
                            </div>
                            <div class="daily-summary-card">
                                <div class="value" id="daily-items-sold">0</div>
                                <div class="label">Daily Items Sold</div>
                            </div>
                        </div>
                        
                        <h4 style="margin-top: 20px; margin-bottom: 10px;">Daily Sales Details</h4>
                        <table class="daily-sales-table">
                            <thead>
                                <tr>
                                    <th>Receipt #</th>
                                    <th>Time</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="daily-sales-table-body">
                                <tr>
                                    <td colspan="5" class="no-data">No sales data for selected date</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Recent Sales Section -->
                    <div class="report-section">
                        <h3><i class="fas fa-history"></i> Recent Sales</h3>
                        <table class="inventory-table">
                            <thead>
                                <tr>
                                    <th>Receipt #</th>
                                    <th>Date</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sales-table-body">
                                <tr>
                                    <td colspan="5" style="text-align: center;">No sales data available</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <!-- Deleted Sales Section -->
                        <div class="deleted-sales-section">
                            <h4><i class="fas fa-trash-alt"></i> Deleted Sales</h4>
                            <table class="deleted-sales-table">
                                <thead>
                                    <tr>
                                        <th>Receipt #</th>
                                        <th>Date</th>
                                        <th>Items</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="deleted-sales-table-body">
                                    <tr>
                                        <td colspan="5" style="text-align: center;">No deleted sales</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Account Page -->
            <div id="account-page" class="page-content" style="display: none;">
                <div class="user-management">
                    <div class="loading-overlay" id="account-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                    </div>
                    <h3>My Account</h3>
                    
                    <div class="user-info-card">
                        <h3>Account Information</h3>
                        <div class="info-row">
                            <span class="info-label">Name:</span>
                            <span class="info-value" id="user-name">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email:</span>
                            <span class="info-value" id="user-email">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Role:</span>
                            <span class="info-value" id="user-role-display">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Account Created:</span>
                            <span class="info-value" id="user-created">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Last Login:</span>
                            <span class="info-value" id="user-last-login">-</span>
                        </div>
                    </div>
                    
                    <div class="inventory-header">
                        <h3>Change Password</h3>
                    </div>
                    
                    <form id="change-password-form">
                        <div class="form-group">
                            <label for="current-password">Current Password</label>
                            <input type="password" id="current-password" required>
                        </div>
                        <div class="form-group">
                            <label for="new-password">New Password</label>
                            <input type="password" id="new-password" required>
                        </div>
                        <div class="form-group">
                            <label for="confirm-new-password">Confirm New Password</label>
                            <input type="password" id="confirm-new-password" required>
                        </div>
                        <button type="submit" class="btn btn-primary" id="change-password-btn">Change Password</button>
                    </form>
                </div>
                
                <!-- User Management Section (Admin Only) -->
                <div class="users-container" id="users-container" style="display: none;">
                    <h3>Manage Users</h3>
                    <div class="users-list" id="users-list">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="loading-overlay" id="product-modal-loading" style="display: none;">
                <div class="loading-spinner"></div>
            </div>
            <div class="modal-header">
                <h3 id="modal-title">Add New Product</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <div class="form-group">
                        <label for="product-name">Product Name</label>
                        <input type="text" id="product-name" required>
                    </div>
                    <div class="form-group">
                        <label for="product-category">Category</label>
                        <select id="product-category" required>
                            <option value="">Select Category</option>
                            <option value="Food">Food</option>
                            <option value="Beverages">Beverages</option>
                            <option value="Household">Household</option>
                            <option value="Personal Care">Personal Care</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="product-price">Price (‚Ç¶)</label>
                        <input type="number" id="product-price" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="product-stock">Initial Stock</label>
                        <input type="number" id="product-stock" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="product-expiry">Expiry Date</label>
                        <input type="date" id="product-expiry" required>
                    </div>
                    <div class="form-group">
                        <label for="product-barcode">Barcode (Optional)</label>
                        <input type="text" id="product-barcode">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-product-btn">Cancel</button>
                <button class="btn btn-primary" id="save-product-btn">Save Product</button>
            </div>
        </div>
    </div>
    
    <!-- Receipt Modal -->
    <div id="receipt-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Transaction Complete</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="receipt" id="receipt-content">
                    <!-- Receipt will be dynamically generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="print-receipt-btn">Print Receipt</button>
                <button class="btn btn-success" id="new-sale-btn">New Sale</button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-message">Operation completed successfully!</span>
    </div>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
        // FIX: Register service worker for offline functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // Offline/Online Detection and Sync Management
        const offlineIndicator = document.getElementById('offline-indicator');
        const syncStatus = document.getElementById('sync-status');
        let isOnline = navigator.onLine;
        let syncQueue = [];
        let connectionRetryCount = 0;
        const MAX_RETRY_ATTEMPTS = 3;
        const RETRY_DELAY = 5000; // 5 seconds
        
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBNs0xDtFR97iFgDQlxn8ueLxFJA4L60Gc",
            authDomain: "point-of-sale-2cc64.firebaseapp.com",
            databaseURL: "https://point-of-sale-2cc64-default-rtdb.firebaseio.com/",
            projectId: "point-of-sale-2cc64",
            storageBucket: "point-of-sale-2cc64.firebasestorage.app",
            messagingSenderId: "365581311369",
            appId: "1:365581311369:web:688fb59bffae277a6ed558",
            measurementId: "G-VGS89T5DSF"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // FIX: Updated to use new Firestore persistence API
        try {
            // Use the new FirestoreSettings.cache API instead of deprecated enableIndexedDbPersistence
            db.settings({
                cache: {
                    // Enable offline persistence
                    persistence: firebase.firestore.LOCAL_PERSISTENCE
                }
            });
            console.log("Firestore persistence enabled with new API");
        } catch (err) {
            console.warn("Error enabling persistence:", err);
        }

        // FIX: Add connection retry logic
        function checkFirebaseConnection() {
            if (!isOnline) return;
            
            // Try a simple read operation to check connection
            db.collection('connection_test').limit(1).get()
                .then(() => {
                    console.log('Firebase connection is working');
                    connectionRetryCount = 0;
                    
                    // Process any pending sync operations
                    if (syncQueue.length > 0) {
                        processSyncQueue();
                    }
                })
                .catch(error => {
                    console.error('Firebase connection check failed:', error);
                    
                    if (connectionRetryCount < MAX_RETRY_ATTEMPTS) {
                        connectionRetryCount++;
                        console.log(`Retrying Firebase connection (${connectionRetryCount}/${MAX_RETRY_ATTEMPTS})...`);
                        
                        setTimeout(checkFirebaseConnection, RETRY_DELAY);
                    } else {
                        console.error('Max retry attempts reached. Firebase connection may be unavailable.');
                        showNotification('Connection to database failed. Some features may be limited.', 'warning');
                    }
                });
        }

        // PWA Install Prompt Setup
        let deferredPrompt;
        const installBtn = document.getElementById('install-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'flex';
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;

            if (outcome === 'accepted') {
                console.log('User accepted the install prompt');
                installBtn.style.display = 'none';
            } else {
                console.log('User dismissed the install prompt');
            }
            deferredPrompt = null;
        });
        
        // Online/Offline Detection
        window.addEventListener('online', () => {
            isOnline = true;
            offlineIndicator.classList.remove('show');
            showNotification('You are back online!', 'success');
            
            // Check Firebase connection
            checkFirebaseConnection();
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            offlineIndicator.classList.add('show');
        });
        
        // ‚úÖ Updated addToSyncQueue() - supports offline sales sync
        function addToSyncQueue(operation) {
            // Avoid duplicate operations
            if (syncQueue.some(op => 
                op.type === operation.type && 
                JSON.stringify(op.data) === JSON.stringify(operation.data)
            )) {
                console.log('Duplicate operation detected ‚Äî skipping');
                return;
            }

            syncQueue.push(operation);
            localStorage.setItem('syncQueue', JSON.stringify(syncQueue));

            if (isOnline) {
                processSyncQueue();
            } else {
                showNotification('Offline: Sale saved locally and will sync automatically.', 'info');
            }
        }

        // ‚úÖ Updated processSyncQueue() - supports offline to online sync
        function processSyncQueue() {
            if (syncQueue.length === 0) return;

            syncStatus.classList.add('show', 'syncing');
            syncStatus.innerHTML = '<i class="fas fa-sync"></i> Syncing data...';

            const operation = syncQueue.shift();

            if (operation.synced) {
                processNext();
                return;
            }

            let operationPromise;

            if (operation.type === 'saveSale') {
                // Check if sale already exists before saving
                operationPromise = db.collection('sales').doc(operation.data.id).get()
                    .then(doc => {
                        if (!doc.exists) {
                            return db.collection('sales').doc(operation.data.id).set(operation.data);
                        } else {
                            console.log(`Sale ${operation.data.id} already exists ‚Äî skipping`);
                            return Promise.resolve();
                        }
                    });
            } else if (operation.type === 'saveProduct') {
                operationPromise = db.collection('products').doc(operation.data.id).set(operation.data);
            } else if (operation.type === 'deleteProduct') {
                operationPromise = db.collection('products').doc(operation.id).delete();
            } else if (operation.type === 'deleteSale') {
                operationPromise = db.collection('sales').doc(operation.id).delete();
            } else {
                operationPromise = Promise.resolve();
            }

            operationPromise
                .then(() => {
                    operation.synced = true;
                    localStorage.setItem('syncQueue', JSON.stringify(syncQueue));
                    processNext();
                })
                .catch(error => {
                    console.error('Sync error:', error);
                    syncQueue.unshift(operation);
                    localStorage.setItem('syncQueue', JSON.stringify(syncQueue));
                    syncStatus.classList.remove('syncing');
                    syncStatus.classList.add('error');
                    syncStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Sync error';
                    setTimeout(() => syncStatus.classList.remove('show', 'error'), 3000);
                });

            function processNext() {
                setTimeout(() => {
                    if (syncQueue.length > 0) {
                        processSyncQueue();
                    } else {
                        syncStatus.classList.remove('syncing');
                        syncStatus.classList.add('show');
                        syncStatus.innerHTML = '<i class="fas fa-check"></i> All data synced';
                        setTimeout(() => syncStatus.classList.remove('show'), 3000);
                    }
                }, 800);
            }
        }
        
        // Load sync queue from localStorage on app start
        function loadSyncQueue() {
            const savedQueue = localStorage.getItem('syncQueue');
            if (savedQueue) {
                try {
                    syncQueue = JSON.parse(savedQueue);
                } catch (e) {
                    console.error('Error parsing sync queue:', e);
                    syncQueue = [];
                }
            }
        }
        
        // Clean up completed sync operations
        function cleanupSyncQueue() {
            syncQueue = syncQueue.filter(op => !op.synced);
            localStorage.setItem('syncQueue', JSON.stringify(syncQueue));
        }
        
        // Data storage
        let products = [];
        let cart = [];
        let sales = [];
        let deletedSales = [];
        let users = [];
        let currentUser = null;
        let currentPage = "pos";
        
        // Settings - Updated phone number as requested
        let settings = {
            storeName: "Pa Gerrys Mart",
            storeAddress: "Alatishe, Ibeju Lekki, Lagos State, Nigeria",
            storePhone: "+2347037850121", // Changed phone number as requested
            lowStockThreshold: 10,
            expiryWarningDays: 90 // 3 months = 90 days
        };
        
        // Local storage keys
        const STORAGE_KEYS = {
            PRODUCTS: 'pagerrysmart_products',
            SALES: 'pagerrysmart_sales',
            DELETED_SALES: 'pagerrysmart_deleted_sales',
            USERS: 'pagerrysmart_users',
            SETTINGS: 'pagerrysmart_settings',
            CURRENT_USER: 'pagerrysmart_current_user'
        };
        
        // Load data from localStorage
        function loadFromLocalStorage() {
            try {
                const savedProducts = localStorage.getItem(STORAGE_KEYS.PRODUCTS);
                if (savedProducts) {
                    products = JSON.parse(savedProducts);
                }
                
                const savedSales = localStorage.getItem(STORAGE_KEYS.SALES);
                if (savedSales) {
                    sales = JSON.parse(savedSales);
                }
                
                const savedDeletedSales = localStorage.getItem(STORAGE_KEYS.DELETED_SALES);
                if (savedDeletedSales) {
                    deletedSales = JSON.parse(savedDeletedSales);
                }
                
                const savedUsers = localStorage.getItem(STORAGE_KEYS.USERS);
                if (savedUsers) {
                    users = JSON.parse(savedUsers);
                }
                
                const savedSettings = localStorage.getItem(STORAGE_KEYS.SETTINGS);
                if (savedSettings) {
                    settings = JSON.parse(savedSettings);
                }
                
                const savedCurrentUser = localStorage.getItem(STORAGE_KEYS.CURRENT_USER);
                if (savedCurrentUser) {
                    currentUser = JSON.parse(savedCurrentUser);
                }
            } catch (e) {
                console.error('Error loading data from localStorage:', e);
            }
        }
        
        // Save data to localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
                localStorage.setItem(STORAGE_KEYS.SALES, JSON.stringify(sales));
                localStorage.setItem(STORAGE_KEYS.DELETED_SALES, JSON.stringify(deletedSales));
                localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
                localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
                
                if (currentUser) {
                    localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                }
            } catch (e) {
                console.error('Error saving data to localStorage:', e);
            }
        }
        
        // DOM elements
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginTabs = document.querySelectorAll('.login-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const navLinks = document.querySelectorAll('.nav-link');
        const pageContents = document.querySelectorAll('.page-content');
        const pageTitle = document.getElementById('page-title');
        const currentUserEl = document.getElementById('current-user');
        const userRoleEl = document.getElementById('user-role');
        const userRoleDisplayEl = document.getElementById('user-role-display');
        const logoutBtn = document.getElementById('logout-btn');
        const productsGrid = document.getElementById('products-grid');
        const cartItems = document.getElementById('cart-items');
        const totalEl = document.getElementById('total');
        const inventoryTableBody = document.getElementById('inventory-table-body');
        const inventoryTotalValueEl = document.getElementById('inventory-total-value');
        const salesTableBody = document.getElementById('sales-table-body');
        const deletedSalesTableBody = document.getElementById('deleted-sales-table-body');
        const dailySalesTableBody = document.getElementById('daily-sales-table-body');
        const productModal = document.getElementById('product-modal');
        const receiptModal = document.getElementById('receipt-modal');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        
        // Loading elements
        const inventoryLoading = document.getElementById('inventory-loading');
        const reportsLoading = document.getElementById('reports-loading');
        const accountLoading = document.getElementById('account-loading');
        const productModalLoading = document.getElementById('product-modal-loading');
        const loginSubmitBtn = document.getElementById('login-submit-btn');
        const registerSubmitBtn = document.getElementById('register-submit-btn');
        const changePasswordBtn = document.getElementById('change-password-btn');
        const saveProductBtn = document.getElementById('save-product-btn');
        const completeSaleBtn = document.getElementById('complete-sale-btn');
        
        // Authentication Module
        const AuthModule = {
            // Sign up new user (admin only)
            async signUp(email, password, name, role = 'cashier') {
                try {
                    // Check if current user is logged in and is admin
                    const adminUser = firebase.auth().currentUser;
                    if (!adminUser) {
                        showNotification("You must be logged in as an admin to create users.", "error");
                        return { success: false };
                    }

                    // Ask admin to confirm their password
                    const adminEmail = adminUser.email;
                    const adminPassword = prompt("Please confirm your admin password to continue:");

                    // Temporarily sign out admin
                    await firebase.auth().signOut();

                    // Create the new user account
                    const newUserCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                    const newUser = newUserCredential.user;

                    // Update profile name
                    await newUser.updateProfile({ displayName: name });

                    // Save user details in Firestore
                    await db.collection("users").doc(newUser.uid).set({
                        uid: newUser.uid,
                        name,
                        email,
                        role,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: adminUser.uid
                    });

                    // Log out the newly created user
                    await firebase.auth().signOut();

                    // Re-sign in admin
                    await firebase.auth().signInWithEmailAndPassword(adminEmail, adminPassword);

                    showNotification(`‚úÖ User "${name}" (${role}) created successfully!`, "success");
                    return { success: true };
                } catch (error) {
                    console.error("Signup error:", error);
                    showNotification("‚ùå Error creating user: " + error.message, "error");
                    return { success: false, error: error.message };
                }
            },

            // Sign in existing user
            async signIn(email, password) {
                // Show loading state
                loginSubmitBtn.classList.add('loading');
                loginSubmitBtn.disabled = true;
                
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    // Update last login
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Get user data from Firestore
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    const userData = userDoc.data();
                    
                    currentUser = {
                        uid: user.uid,
                        ...userData
                    };
                    
                    localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                    showApp();
                    showNotification('Login successful!', 'success');
                    return { success: true };
                } catch (error) {
                    console.error('Signin error:', error);
                    showNotification(error.message, 'error');
                    return { success: false, error: error.message };
                } finally {
                    // Hide loading state
                    loginSubmitBtn.classList.remove('loading');
                    loginSubmitBtn.disabled = false;
                }
            },
            
            // Sign out
            async signOut() {
                try {
                    await auth.signOut();
                    currentUser = null;
                    localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                    showLogin();
                    showNotification('Logged out successfully', 'info');
                } catch (error) {
                    console.error('Signout error:', error);
                    showNotification(error.message, 'error');
                }
            },
            
            // Check if user is admin
            isAdmin() {
                return currentUser && currentUser.role === 'admin';
            },
            
            // Listen to auth state changes
            onAuthStateChanged(callback) {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // User is signed in
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        const userData = userDoc.data();
                        
                        if (userData) {
                            currentUser = {
                                uid: user.uid,
                                ...userData
                            };
                            localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                            callback(currentUser);
                        }
                    } else {
                        // User is signed out
                        currentUser = null;
                        localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                        callback(null);
                    }
                });
            }
        };
        
        // FIX: Data Module with improved error handling
        const DataModule = {
            // NEW: Fetch products from Firestore
            async fetchProducts() {
                try {
                    if (isOnline) {
                        const snapshot = await db.collection('products').get();
                        const fetchedProducts = [];
                        snapshot.forEach((doc) => {
                            fetchedProducts.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // Update global products variable
                        products = fetchedProducts;
                        saveToLocalStorage();
                        
                        return products;
                    } else {
                        // Offline: Use local data
                        return products;
                    }
                } catch (error) {
                    console.error('Error fetching products:', error);
                    // Fall back to local data
                    return products;
                }
            },
            
            // NEW: Fetch sales from Firestore
            async fetchSales() {
                try {
                    if (isOnline) {
                        const snapshot = await db.collection('sales').get();
                        const fetchedSales = [];
                        snapshot.forEach((doc) => {
                            fetchedSales.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // Update global sales variable
                        sales = fetchedSales;
                        saveToLocalStorage();
                        
                        return sales;
                    } else {
                        // Offline: Use local data
                        return sales;
                    }
                } catch (error) {
                    console.error('Error fetching sales:', error);
                    // Fall back to local data
                    return sales;
                }
            },
            
            // NEW: Fetch deleted sales from Firestore
            async fetchDeletedSales() {
                try {
                    if (isOnline) {
                        const snapshot = await db.collection('deletedSales').get();
                        const fetchedDeletedSales = [];
                        snapshot.forEach((doc) => {
                            fetchedDeletedSales.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // Update global deletedSales variable
                        deletedSales = fetchedDeletedSales;
                        saveToLocalStorage();
                        
                        return deletedSales;
                    } else {
                        // Offline: Use local data
                        return deletedSales;
                    }
                } catch (error) {
                    console.error('Error fetching deleted sales:', error);
                    // Fall back to local data
                    return deletedSales;
                }
            },
            
            // Products
            async saveProduct(product) {
                // Show loading state
                productModalLoading.style.display = 'flex';
                saveProductBtn.disabled = true;
                
                try {
                    if (isOnline) {
                        // Online: Save to Firebase
                        if (product.id && !product.id.startsWith('temp_')) {
                            // Update existing product
                            await db.collection('products').doc(product.id).update(product);
                        } else {
                            // Add new product
                            const docRef = await db.collection('products').add(product);
                            product.id = docRef.id;
                        }
                        
                        // Update local cache
                        const index = products.findIndex(p => p.id === product.id);
                        if (index >= 0) {
                            products[index] = product;
                        } else {
                            products.push(product);
                        }
                        
                        saveToLocalStorage();
                        return { success: true, product };
                    } else {
                        // Offline: Save to localStorage and add to sync queue
                        if (product.id && !product.id.startsWith('temp_')) {
                            // Update existing product
                            const index = products.findIndex(p => p.id === product.id);
                            if (index >= 0) {
                                products[index] = product;
                            }
                        } else {
                            // Add new product with temporary ID
                            product.id = 'temp_' + Date.now();
                            products.push(product);
                        }
                        
                        saveToLocalStorage();
                        
                        // Add to sync queue
                        addToSyncQueue({
                            type: 'saveProduct',
                            data: product
                        });
                        
                        return { success: true, product };
                    }
                } catch (error) {
                    console.error('Error saving product:', error);
                    
                    // Check if it's a network error
                    if (error.code === 'unavailable' || error.code === 'deadline-exceeded') {
                        // Try to save locally
                        if (!product.id || product.id.startsWith('temp_')) {
                            product.id = 'temp_' + Date.now();
                        }
                        
                        const index = products.findIndex(p => p.id === product.id);
                        if (index >= 0) {
                            products[index] = product;
                        } else {
                            products.push(product);
                        }
                        
                        saveToLocalStorage();
                        
                        // Add to sync queue
                        addToSyncQueue({
                            type: 'saveProduct',
                            data: product
                        });
                        
                        showNotification('Saved locally. Will sync when connection is restored.', 'warning');
                        return { success: true, product };
                    } else {
                        showNotification('Error saving product: ' + error.message, 'error');
                        return { success: false, error };
                    }
                } finally {
                    // Hide loading state
                    productModalLoading.style.display = 'none';
                    saveProductBtn.disabled = false;
                }
            },
            
            async deleteProduct(productId) {
                try {
                    if (isOnline) {
                        // Online: Delete from Firebase
                        await db.collection('products').doc(productId).delete();
                        
                        // Update local cache
                        products = products.filter(p => p.id !== productId);
                        saveToLocalStorage();
                        
                        return { success: true };
                    } else {
                        // Offline: Mark as deleted in localStorage and add to sync queue
                        const index = products.findIndex(p => p.id === productId);
                        if (index >= 0) {
                            products[index].deleted = true;
                            products[index].deletedAt = new Date().toISOString();
                        }
                        
                        saveToLocalStorage();
                        
                        // Add to sync queue
                        addToSyncQueue({
                            type: 'deleteProduct',
                            id: productId
                        });
                        
                        return { success: true };
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    showNotification('Error deleting product', 'error');
                    return { success: false, error };
                }
            },
            
            // Sales - FIXED VERSION
            async saveSale(sale) {
                try {
                    if (isOnline) {
                        // Online: Save to Firebase
                        const docRef = await db.collection('sales').add(sale);
                        sale.id = docRef.id;
                        
                        // Update local cache to ensure UI updates immediately
                        sales.push(sale);
                        saveToLocalStorage();
                        
                        return { success: true, sale };
                    } else {
                        // Offline: Save to localStorage and add to sync queue
                        // Use a consistent ID format that can be matched later
                        sale.id = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        sales.push(sale);
                        saveToLocalStorage();
                        
                        // Add to sync queue
                        addToSyncQueue({
                            type: 'saveSale',
                            data: sale
                        });
                        
                        return { success: true, sale };
                    }
                } catch (error) {
                    console.error('Error saving sale:', error);
                    showNotification('Error saving sale', 'error');
                    return { success: false, error };
                }
            },
            
            // FIX 2: Improved deleteSale function
            async deleteSale(saleId) {
                try {
                    if (isOnline) {
                        // Online: Move to deleted sales in Firebase
                        const saleDoc = await db.collection('sales').doc(saleId).get();
                        if (saleDoc.exists) {
                            const saleData = saleDoc.data();
                            // Add a deleted flag and timestamp
                            saleData.deleted = true;
                            saleData.deletedAt = firebase.firestore.FieldValue.serverTimestamp();
                            
                            // Add to deletedSales collection
                            await db.collection('deletedSales').add(saleData);
                            
                            // Delete from sales collection
                            await db.collection('sales').doc(saleId).delete();
                            
                            // Update local cache
                            const saleIndex = sales.findIndex(s => s.id === saleId);
                            if (saleIndex >= 0) {
                                const sale = sales[saleIndex];
                                sale.deleted = true;
                                sale.deletedAt = new Date().toISOString();
                                deletedSales.push(sale);
                                sales.splice(saleIndex, 1);
                            }
                            
                            saveToLocalStorage();
                            return { success: true };
                        } else {
                            return { success: false, error: 'Sale not found' };
                        }
                    } else {
                        // Offline: Mark as deleted in localStorage and add to sync queue
                        const saleIndex = sales.findIndex(s => s.id === saleId);
                        if (saleIndex >= 0) {
                            const sale = sales[saleIndex];
                            sale.deleted = true;
                            sale.deletedAt = new Date().toISOString();
                            deletedSales.push(sale);
                            sales.splice(saleIndex, 1);
                            
                            saveToLocalStorage();
                            
                            // Add to sync queue
                            addToSyncQueue({
                                type: 'deleteSale',
                                id: saleId
                            });
                            
                            return { success: true };
                        } else {
                            return { success: false, error: 'Sale not found' };
                        }
                    }
                } catch (error) {
                    console.error('Error deleting sale:', error);
                    showNotification('Error deleting sale', 'error');
                    return { success: false, error };
                }
            },
            
            // Real-time listeners - FIXED VERSION
            listenToProducts(callback) {
                if (isOnline) {
                    return db.collection('products').onSnapshot((snapshot) => {
                        const fetchedProducts = [];
                        snapshot.forEach((doc) => {
                            fetchedProducts.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // Update global products variable
                        products = fetchedProducts;
                        saveToLocalStorage();
                        
                        callback(products);
                    });
                } else {
                    // Offline: Use local data
                    callback(products);
                    return () => {}; // Return empty unsubscribe function
                }
            },
            
            listenToSales(callback) {
                if (isOnline) {
                    return db.collection('sales').onSnapshot((snapshot) => {
                        const fetchedSales = [];
                        snapshot.forEach((doc) => {
                            fetchedSales.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // Update global sales variable
                        sales = fetchedSales;
                        saveToLocalStorage();
                        
                        callback(sales);
                    });
                } else {
                    // Offline: Use local data
                    callback(sales);
                    return () => {}; // Return empty unsubscribe function
                }
            },
            
            listenToDeletedSales(callback) {
                if (isOnline) {
                    return db.collection('deletedSales').onSnapshot((snapshot) => {
                        const fetchedDeletedSales = [];
                        snapshot.forEach((doc) => {
                            fetchedDeletedSales.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // Update global deletedSales variable
                        deletedSales = fetchedDeletedSales;
                        saveToLocalStorage();
                        
                        callback(deletedSales);
                    });
                } else {
                    // Offline: Use local data
                    callback(deletedSales);
                    return () => {}; // Return empty unsubscribe function
                }
            }
        };
        
        // UI Functions
        function showLogin() {
            loginPage.style.display = 'flex';
            appContainer.style.display = 'none';
        }
        
        async function showApp() {
            loginPage.style.display = 'none';
            appContainer.style.display = 'flex';
            
            // Update user info
            if (currentUser) {
                currentUserEl.textContent = currentUser.name;
                userRoleEl.textContent = currentUser.role;
                userRoleDisplayEl.textContent = currentUser.role;
                
                // Show/hide admin features
                const usersContainer = document.getElementById('users-container');
                if (AuthModule.isAdmin()) {
                    usersContainer.style.display = 'block';
                } else {
                    usersContainer.style.display = 'none';
                }
            }
            
            // Fetch initial data from Firestore
            try {
                products = await DataModule.fetchProducts();
                sales = await DataModule.fetchSales();
                deletedSales = await DataModule.fetchDeletedSales();
                
                // Load data into UI
                loadProducts();
                loadSales();
                
                // Set up real-time listeners
                DataModule.listenToProducts(loadProducts);
                DataModule.listenToSales(loadSales);
                DataModule.listenToDeletedSales(loadDeletedSales);
            } catch (error) {
                console.error('Error loading initial data:', error);
                showNotification('Error loading data. Using offline cache.', 'warning');
                
                // Fall back to local data
                loadProducts();
                loadSales();
                
                // Set up real-time listeners
                DataModule.listenToProducts(loadProducts);
                DataModule.listenToSales(loadSales);
                DataModule.listenToDeletedSales(loadDeletedSales);
            }
        }
        
        function showNotification(message, type = 'success') {
            notificationMessage.textContent = message;
            notification.className = `notification ${type} show`;
            
            // Update icon based on type
            const icon = notification.querySelector('i');
            icon.className = type === 'success' ? 'fas fa-check-circle' : 
                           type === 'error' ? 'fas fa-exclamation-circle' : 
                           type === 'warning' ? 'fas fa-exclamation-triangle' : 
                           'fas fa-info-circle';
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-NG', { 
                style: 'currency', 
                currency: 'NGN',
                minimumFractionDigits: 2
            }).format(amount);
        }
        
        // FIX: Added null check for toDate() function
        function formatDate(date) {
            if (!date) return '-';
            
            // Check if date is a Firestore Timestamp
            if (date && typeof date.toDate === 'function') {
                const d = date.toDate();
                return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
            
            // If it's already a Date object or string
            const d = date instanceof Date ? date : new Date(date);
            
            // Check if the date is valid
            if (isNaN(d.getTime())) {
                return '-';
            }
            
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        function generateReceiptNumber() {
            const date = new Date();
            const year = date.getFullYear().toString().substr(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            return `R${year}${month}${day}${random}`;
        }
        
        // Page Navigation
        function showPage(pageName) {
            // Hide all pages
            pageContents.forEach(page => {
                page.style.display = 'none';
            });
            
            // Show selected page
            const selectedPage = document.getElementById(`${pageName}-page`);
            if (selectedPage) {
                selectedPage.style.display = 'block';
            }
            
            // Update active nav link
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-page') === pageName) {
                    link.classList.add('active');
                }
            });
            
            // Update page title
            const titles = {
                'pos': 'Point of Sale',
                'inventory': 'Inventory Management',
                'reports': 'Sales Reports',
                'account': 'My Account'
            };
            
            pageTitle.textContent = titles[pageName] || 'Pa Gerrys Mart';
            currentPage = pageName;
            
            // Load page-specific data
            if (pageName === 'inventory') {
                loadInventory();
            } else if (pageName === 'reports') {
                loadReports();
            } else if (pageName === 'account') {
                loadAccount();
            }
        }
        
        // Product Functions
        function loadProducts() {
            if (products.length === 0) {
                productsGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h3>No Products Added Yet</h3>
                        <p>Click "Add Product" to start adding your inventory</p>
                    </div>
                `;
                return;
            }
            
            productsGrid.innerHTML = '';
            
            products.forEach(product => {
                // Skip deleted products
                if (product.deleted) return;
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                // Check expiry status
                const today = new Date();
                const expiryDate = new Date(product.expiryDate);
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                let expiryWarning = '';
                if (daysUntilExpiry < 0) {
                    expiryWarning = `<div class="expiry-warning"><i class="fas fa-exclamation-triangle"></i> Expired</div>`;
                } else if (daysUntilExpiry <= settings.expiryWarningDays) {
                    expiryWarning = `<div class="expiry-warning"><i class="fas fa-clock"></i> Expires in ${daysUntilExpiry} days</div>`;
                }
                
                // Check stock status
                let stockClass = 'stock-high';
                if (product.stock <= 0) {
                    stockClass = 'stock-low';
                } else if (product.stock <= settings.lowStockThreshold) {
                    stockClass = 'stock-medium';
                }
                
                productCard.innerHTML = `
                    <div class="product-img">
                        <i class="fas fa-box"></i>
                    </div>
                    <h4>${product.name}</h4>
                    <div class="price">${formatCurrency(product.price)}</div>
                    <div class="stock ${stockClass}">Stock: ${product.stock}</div>
                    ${expiryWarning}
                `;
                
                productCard.addEventListener('click', () => addToCart(product));
                productsGrid.appendChild(productCard);
            });
        }
        
        function loadInventory() {
            inventoryLoading.style.display = 'flex';
            
            setTimeout(() => {
                inventoryLoading.style.display = 'none';
                
                if (products.length === 0) {
                    inventoryTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center;">No products in inventory</td>
                        </tr>
                    `;
                    inventoryTotalValueEl.textContent = formatCurrency(0);
                    return;
                }
                
                let totalValue = 0;
                inventoryTableBody.innerHTML = '';
                
                products.forEach(product => {
                    // Skip deleted products
                    if (product.deleted) return;
                    
                    totalValue += product.price * product.stock;
                    
                    // Check expiry status
                    const today = new Date();
                    const expiryDate = new Date(product.expiryDate);
                    const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                    
                    let rowClass = '';
                    let stockBadgeClass = 'stock-high';
                    let stockBadgeText = 'In Stock';
                    
                    if (product.stock <= 0) {
                        stockBadgeClass = 'stock-low';
                        stockBadgeText = 'Out of Stock';
                    } else if (product.stock <= settings.lowStockThreshold) {
                        stockBadgeClass = 'stock-medium';
                        stockBadgeText = 'Low Stock';
                    }
                    
                    let expiryBadgeClass = 'expiry-good';
                    let expiryBadgeText = 'Good';
                    
                    if (daysUntilExpiry < 0) {
                        expiryBadgeClass = 'expiry-expired';
                        expiryBadgeText = 'Expired';
                        rowClass = 'expired';
                    } else if (daysUntilExpiry <= settings.expiryWarningDays) {
                        expiryBadgeClass = 'expiry-warning';
                        expiryBadgeText = 'Expiring Soon';
                        rowClass = 'expiring-soon';
                    }
                    
                    const row = document.createElement('tr');
                    if (rowClass) row.className = rowClass;
                    
                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>${formatCurrency(product.price)}</td>
                        <td>${product.stock}</td>
                        <td>${formatDate(product.expiryDate)}</td>
                        <td>
                            <span class="stock-badge ${stockBadgeClass}">${stockBadgeText}</span>
                            <span class="expiry-badge ${expiryBadgeClass}">${expiryBadgeText}</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-edit" onclick="editProduct('${product.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-delete" onclick="deleteProduct('${product.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    inventoryTableBody.appendChild(row);
                });
                
                inventoryTotalValueEl.textContent = formatCurrency(totalValue);
            }, 500);
        }
        
        function loadSales() {
            // This will be called by real-time listeners
            updateSalesTables();
        }
        
        function loadDeletedSales() {
            // This will be called by real-time listeners
            updateSalesTables();
        }
        
        // FIX: Added null checks for toDate() in updateSalesTables
        function updateSalesTables() {
            // Update recent sales table
            if (sales.length === 0) {
                salesTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center;">No sales data available</td>
                    </tr>
                `;
            } else {
                salesTableBody.innerHTML = '';
                
                // Sort sales by date (newest first)
                const sortedSales = [...sales].sort((a, b) => {
                    // FIX: Added null checks for toDate()
                    const dateA = a.createdAt && typeof a.createdAt.toDate === 'function' 
                        ? a.createdAt.toDate() 
                        : new Date(a.createdAt || 0);
                    const dateB = b.createdAt && typeof b.createdAt.toDate === 'function' 
                        ? b.createdAt.toDate() 
                        : new Date(b.createdAt || 0);
                    return dateB - dateA;
                });
                
                // Show only the last 10 sales
                const recentSales = sortedSales.slice(0, 10);
                
                recentSales.forEach(sale => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${sale.receiptNumber}</td>
                        <td>${formatDate(sale.createdAt)}</td>
                        <td>${sale.items.length}</td>
                        <td>${formatCurrency(sale.total)}</td>
                        <td>
                            <button class="btn-edit" onclick="viewSale('${sale.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    
                    salesTableBody.appendChild(row);
                });
            }
            
            // Update deleted sales table
            if (deletedSales.length === 0) {
                deletedSalesTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center;">No deleted sales</td>
                    </tr>
                `;
            } else {
                deletedSalesTableBody.innerHTML = '';
                
                // Sort deleted sales by date (newest first)
                const sortedDeletedSales = [...deletedSales].sort((a, b) => {
                    // FIX: Added null checks for toDate()
                    const dateA = a.deletedAt && typeof a.deletedAt.toDate === 'function' 
                        ? a.deletedAt.toDate() 
                        : new Date(a.deletedAt || 0);
                    const dateB = b.deletedAt && typeof b.deletedAt.toDate === 'function' 
                        ? b.deletedAt.toDate() 
                        : new Date(b.deletedAt || 0);
                    return dateB - dateA;
                });
                
                sortedDeletedSales.forEach(sale => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${sale.receiptNumber}</td>
                        <td>${formatDate(sale.createdAt)}</td>
                        <td>${sale.items.length}</td>
                        <td>${formatCurrency(sale.total)}</td>
                        <td><span class="deleted-badge">Deleted</span></td>
                    `;
                    
                    deletedSalesTableBody.appendChild(row);
                });
            }
        }
        
        function loadReports() {
            reportsLoading.style.display = 'flex';
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('report-date').value = today;
            
            setTimeout(() => {
                reportsLoading.style.display = 'none';
                generateReport();
            }, 500);
        }
        
        // FIX: Added null checks for toDate() in generateReport
        function generateReport() {
            const selectedDate = document.getElementById('report-date').value;
            
            // Calculate overall summary
            let totalSales = 0;
            let totalTransactions = sales.length;
            let totalItemsSold = 0;
            
            sales.forEach(sale => {
                totalSales += sale.total;
                totalItemsSold += sale.items.length;
            });
            
            document.getElementById('report-total-sales').textContent = formatCurrency(totalSales);
            document.getElementById('report-transactions').textContent = totalTransactions;
            document.getElementById('report-items-sold').textContent = totalItemsSold;
            
            // Calculate daily summary
            let dailyTotal = 0;
            let dailyTransactions = 0;
            let dailyItems = 0;
            
            const dailySales = [];
            
            sales.forEach(sale => {
                // FIX: Added null checks for toDate()
                const saleDate = sale.createdAt && typeof sale.createdAt.toDate === 'function' 
                    ? sale.createdAt.toDate() 
                    : new Date(sale.createdAt || 0);
                const saleDateString = saleDate.toISOString().split('T')[0];
                
                if (saleDateString === selectedDate) {
                    dailyTotal += sale.total;
                    dailyTransactions++;
                    dailyItems += sale.items.length;
                    dailySales.push(sale);
                }
            });
            
            document.getElementById('daily-total-sales').textContent = formatCurrency(dailyTotal);
            document.getElementById('daily-transactions').textContent = dailyTransactions;
            document.getElementById('daily-items-sold').textContent = dailyItems;
            
            // Update daily sales table
            if (dailySales.length === 0) {
                dailySalesTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-data">No sales data for selected date</td>
                    </tr>
                `;
            } else {
                dailySalesTableBody.innerHTML = '';
                
                // Sort by time
                dailySales.sort((a, b) => {
                    // FIX: Added null checks for toDate()
                    const dateA = a.createdAt && typeof a.createdAt.toDate === 'function' 
                        ? a.createdAt.toDate() 
                        : new Date(a.createdAt || 0);
                    const dateB = b.createdAt && typeof b.createdAt.toDate === 'function' 
                        ? b.createdAt.toDate() 
                        : new Date(b.createdAt || 0);
                    return dateB - dateA;
                });
                
                dailySales.forEach(sale => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${sale.receiptNumber}</td>
                        <td>${formatDate(sale.createdAt)}</td>
                        <td>${sale.items.length}</td>
                        <td>${formatCurrency(sale.total)}</td>
                        <td>
                            <button class="btn-edit" onclick="viewSale('${sale.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    
                    dailySalesTableBody.appendChild(row);
                });
            }
        }
        
        function loadAccount() {
            accountLoading.style.display = 'flex';
            
            setTimeout(() => {
                accountLoading.style.display = 'none';
                
                if (currentUser) {
                    document.getElementById('user-name').textContent = currentUser.name;
                    document.getElementById('user-email').textContent = currentUser.email;
                    document.getElementById('user-role-display').textContent = currentUser.role;
                    document.getElementById('user-created').textContent = formatDate(currentUser.createdAt);
                    document.getElementById('user-last-login').textContent = formatDate(currentUser.lastLogin);
                }
                
                // Load users if admin
                if (AuthModule.isAdmin()) {
                    loadUsers();
                }
            }, 500);
        }
        
        function loadUsers() {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';
            
            if (users.length === 0) {
                usersList.innerHTML = '<p>No users found</p>';
                return;
            }
            
            users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                
                userCard.innerHTML = `
                    <div class="user-info">
                        <strong>${user.name}</strong>
                        <span>${user.email}</span>
                        <span class="role-badge ${user.role}">${user.role}</span>
                    </div>
                    <div class="action-buttons">
                        <button class="btn-delete" onclick="deleteUser('${user.uid}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                usersList.appendChild(userCard);
            });
        }
        
        // Cart Functions
        function addToCart(product) {
            // Check if product is in stock
            if (product.stock <= 0) {
                showNotification('Product is out of stock', 'error');
                return;
            }
            
            // Check if product is already in cart
            const existingItem = cart.find(item => item.id === product.id);
            
            if (existingItem) {
                // Check if adding one more would exceed stock
                if (existingItem.quantity >= product.stock) {
                    showNotification('Not enough stock available', 'error');
                    return;
                }
                
                existingItem.quantity++;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
            
            updateCart();
        }
        
        function updateCart() {
            if (cart.length === 0) {
                cartItems.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No items in cart</p>';
                totalEl.textContent = formatCurrency(0);
                return;
            }
            
            cartItems.innerHTML = '';
            let total = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${formatCurrency(item.price)}</div>
                        <div class="cart-item-qty">
                            <button onclick="updateQuantity('${item.id}', -1)">-</button>
                            <input type="number" value="${item.quantity}" min="1" readonly>
                            <button onclick="updateQuantity('${item.id}', 1)">+</button>
                        </div>
                    </div>
                    <div class="cart-item-total">${formatCurrency(itemTotal)}</div>
                `;
                
                cartItems.appendChild(cartItem);
            });
            
            totalEl.textContent = formatCurrency(total);
        }
        
        function updateQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;
            
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const newQuantity = item.quantity + change;
            
            // Check if new quantity is valid
            if (newQuantity <= 0) {
                // Remove item from cart
                cart = cart.filter(item => item.id !== productId);
            } else if (newQuantity <= product.stock) {
                // Update quantity
                item.quantity = newQuantity;
            } else {
                showNotification('Not enough stock available', 'error');
                return;
            }
            
            updateCart();
        }
        
        function clearCart() {
            cart = [];
            updateCart();
        }
        
        async function completeSale() {
            if (cart.length === 0) {
                showNotification('Cart is empty', 'error');
                return;
            }
            
            // Show loading state
            completeSaleBtn.classList.add('loading');
            completeSaleBtn.disabled = true;
            
            try {
                // Create sale object
                const sale = {
                    receiptNumber: generateReceiptNumber(),
                    items: [...cart],
                    total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    createdAt: new Date(),
                    cashier: currentUser.name,
                    cashierId: currentUser.uid
                };
                
                // Save sale
                const result = await DataModule.saveSale(sale);
                
                if (result.success) {
                    // Update product stock
                    for (const cartItem of cart) {
                        const product = products.find(p => p.id === cartItem.id);
                        if (product) {
                            product.stock -= cartItem.quantity;
                            
                            // Save product with updated stock
                            await DataModule.saveProduct(product);
                        }
                    }
                    
                    // Show receipt
                    showReceipt(sale);
                    
                    // Clear cart
                    cart = [];
                    updateCart();
                    
                    showNotification('Sale completed successfully', 'success');
                } else {
                    showNotification('Failed to complete sale', 'error');
                }
            } catch (error) {
                console.error('Error completing sale:', error);
                showNotification('Error completing sale', 'error');
            } finally {
                // Hide loading state
                completeSaleBtn.classList.remove('loading');
                completeSaleBtn.disabled = false;
            }
        }
        
        function showReceipt(sale) {
            const receiptContent = document.getElementById('receipt-content');
            
            let itemsHtml = '';
            sale.items.forEach(item => {
                itemsHtml += `
                    <div class="receipt-item">
                        <span>${item.name} x${item.quantity}</span>
                        <span>${formatCurrency(item.price * item.quantity)}</span>
                    </div>
                `;
            });
            
            receiptContent.innerHTML = `
                <div class="receipt-header">
                    <h2>${settings.storeName}</h2>
                    <p>${settings.storeAddress}</p>
                    <p>${settings.storePhone}</p>
                </div>
                <div class="receipt-items">
                    ${itemsHtml}
                </div>
                <div class="receipt-footer">
                    <div class="receipt-total">
                        <span>Total:</span>
                        <span>${formatCurrency(sale.total)}</span>
                    </div>
                    <div class="receipt-item">
                        <span>Receipt #:</span>
                        <span>${sale.receiptNumber}</span>
                    </div>
                    <div class="receipt-item">
                        <span>Date:</span>
                        <span>${formatDate(sale.createdAt)}</span>
                    </div>
                    <div class="receipt-item">
                        <span>Cashier:</span>
                        <span>${sale.cashier}</span>
                    </div>
                </div>
            `;
            
            receiptModal.style.display = 'flex';
        }
        
        function printReceipt() {
            const receiptContent = document.getElementById('receipt-content').innerHTML;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Receipt - ${settings.storeName}</title>
                        <style>
                            body { font-family: 'Courier New', monospace; padding: 20px; }
                            .receipt-header { text-align: center; margin-bottom: 20px; }
                            .receipt-items { margin-bottom: 20px; }
                            .receipt-item { display: flex; justify-content: space-between; margin-bottom: 8px; }
                            .receipt-footer { border-top: 1px dashed #ccc; padding-top: 10px; }
                            .receipt-total { display: flex; justify-content: space-between; font-weight: 700; margin-bottom: 5px; }
                        </style>
                    </head>
                    <body>
                        ${receiptContent}
                    </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }
        
        // Product Modal Functions
        function openProductModal(product = null) {
            const modalTitle = document.getElementById('modal-title');
            const productForm = document.getElementById('product-form');
            
            if (product) {
                // Edit mode
                modalTitle.textContent = 'Edit Product';
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-category').value = product.category;
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-stock').value = product.stock;
                document.getElementById('product-expiry').value = product.expiryDate;
                document.getElementById('product-barcode').value = product.barcode || '';
                
                // Store product ID for editing
                productForm.dataset.productId = product.id;
            } else {
                // Add mode
                modalTitle.textContent = 'Add New Product';
                productForm.reset();
                delete productForm.dataset.productId;
            }
            
            productModal.style.display = 'flex';
        }
        
        function closeProductModal() {
            productModal.style.display = 'none';
        }
        
        async function saveProduct() {
            const productForm = document.getElementById('product-form');
            const productId = productForm.dataset.productId;
            
            const productData = {
                name: document.getElementById('product-name').value,
                category: document.getElementById('product-category').value,
                price: parseFloat(document.getElementById('product-price').value),
                stock: parseInt(document.getElementById('product-stock').value),
                expiryDate: document.getElementById('product-expiry').value,
                barcode: document.getElementById('product-barcode').value
            };
            
            if (productId) {
                // Update existing product
                productData.id = productId;
            }
            
            const result = await DataModule.saveProduct(productData);
            
            if (result.success) {
                closeProductModal();
                loadProducts();
                if (currentPage === 'inventory') {
                    loadInventory();
                }
                showNotification(productId ? 'Product updated successfully' : 'Product added successfully', 'success');
            } else {
                showNotification('Failed to save product', 'error');
            }
        }
        
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                openProductModal(product);
            }
        }
        
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }
            
            const result = await DataModule.deleteProduct(productId);
            
            if (result.success) {
                loadProducts();
                if (currentPage === 'inventory') {
                    loadInventory();
                }
                showNotification('Product deleted successfully', 'success');
            } else {
                showNotification('Failed to delete product', 'error');
            }
        }
        
        function viewSale(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (sale) {
                showReceipt(sale);
            }
        }
        
        // Event Listeners
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            AuthModule.signIn(email, password);
        });
        
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const role = document.getElementById('register-role').value;
            
            if (password !== confirmPassword) {
                document.getElementById('register-error').style.display = 'block';
                document.getElementById('register-error').textContent = 'Passwords do not match';
                return;
            }
            
            // Show loading state
            registerSubmitBtn.classList.add('loading');
            registerSubmitBtn.disabled = true;
            
            AuthModule.signUp(email, password, name, role)
                .then(result => {
                    if (result.success) {
                        // Switch to login tab
                        document.querySelector('[data-tab="login"]').click();
                        registerForm.reset();
                    }
                })
                .finally(() => {
                    // Hide loading state
                    registerSubmitBtn.classList.remove('loading');
                    registerSubmitBtn.disabled = false;
                });
        });
        
        // Login tabs
        loginTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                
                // Update active tab
                loginTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show corresponding content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabName}-tab` || content.id === `${tabName}-content`) {
                        content.classList.add('active');
                    }
                });
                
                // Hide error messages
                document.getElementById('login-error').style.display = 'none';
                document.getElementById('register-error').style.display = 'none';
            });
        });
        
        // Navigation
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageName = link.getAttribute('data-page');
                showPage(pageName);
            });
        });
        
        // Mobile menu
        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });
        
        // Logout
        logoutBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to logout?')) {
                AuthModule.signOut();
            }
        });
        
        // Product search
        document.getElementById('search-btn').addEventListener('click', () => {
            const searchTerm = document.getElementById('product-search').value.toLowerCase();
            
            if (!searchTerm) {
                loadProducts();
                return;
            }
            
            const filteredProducts = products.filter(product => {
                return product.name.toLowerCase().includes(searchTerm) ||
                       product.category.toLowerCase().includes(searchTerm) ||
                       (product.barcode && product.barcode.toLowerCase().includes(searchTerm));
            });
            
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>No products found</h3>
                        <p>Try a different search term</p>
                    </div>
                `;
                return;
            }
            
            productsGrid.innerHTML = '';
            
            filteredProducts.forEach(product => {
                // Skip deleted products
                if (product.deleted) return;
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                // Check expiry status
                const today = new Date();
                const expiryDate = new Date(product.expiryDate);
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                let expiryWarning = '';
                if (daysUntilExpiry < 0) {
                    expiryWarning = `<div class="expiry-warning"><i class="fas fa-exclamation-triangle"></i> Expired</div>`;
                } else if (daysUntilExpiry <= settings.expiryWarningDays) {
                    expiryWarning = `<div class="expiry-warning"><i class="fas fa-clock"></i> Expires in ${daysUntilExpiry} days</div>`;
                }
                
                // Check stock status
                let stockClass = 'stock-high';
                if (product.stock <= 0) {
                    stockClass = 'stock-low';
                } else if (product.stock <= settings.lowStockThreshold) {
                    stockClass = 'stock-medium';
                }
                
                productCard.innerHTML = `
                    <div class="product-img">
                        <i class="fas fa-box"></i>
                    </div>
                    <h4>${product.name}</h4>
                    <div class="price">${formatCurrency(product.price)}</div>
                    <div class="stock ${stockClass}">Stock: ${product.stock}</div>
                    ${expiryWarning}
                `;
                
                productCard.addEventListener('click', () => addToCart(product));
                productsGrid.appendChild(productCard);
            });
        });
        
        // Inventory search
        document.getElementById('inventory-search-btn').addEventListener('click', () => {
            const searchTerm = document.getElementById('inventory-search').value.toLowerCase();
            
            if (!searchTerm) {
                loadInventory();
                return;
            }
            
            const filteredProducts = products.filter(product => {
                return product.name.toLowerCase().includes(searchTerm) ||
                       product.category.toLowerCase().includes(searchTerm) ||
                       product.id.toLowerCase().includes(searchTerm);
            });
            
            if (filteredProducts.length === 0) {
                inventoryTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center;">No products found</td>
                    </tr>
                `;
                inventoryTotalValueEl.textContent = formatCurrency(0);
                return;
            }
            
            let totalValue = 0;
            inventoryTableBody.innerHTML = '';
            
            filteredProducts.forEach(product => {
                // Skip deleted products
                if (product.deleted) return;
                
                totalValue += product.price * product.stock;
                
                // Check expiry status
                const today = new Date();
                const expiryDate = new Date(product.expiryDate);
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                let rowClass = '';
                let stockBadgeClass = 'stock-high';
                let stockBadgeText = 'In Stock';
                
                if (product.stock <= 0) {
                    stockBadgeClass = 'stock-low';
                    stockBadgeText = 'Out of Stock';
                } else if (product.stock <= settings.lowStockThreshold) {
                    stockBadgeClass = 'stock-medium';
                    stockBadgeText = 'Low Stock';
                }
                
                let expiryBadgeClass = 'expiry-good';
                let expiryBadgeText = 'Good';
                
                if (daysUntilExpiry < 0) {
                    expiryBadgeClass = 'expiry-expired';
                    expiryBadgeText = 'Expired';
                    rowClass = 'expired';
                } else if (daysUntilExpiry <= settings.expiryWarningDays) {
                    expiryBadgeClass = 'expiry-warning';
                    expiryBadgeText = 'Expiring Soon';
                    rowClass = 'expiring-soon';
                }
                
                const row = document.createElement('tr');
                if (rowClass) row.className = rowClass;
                
                row.innerHTML = `
                    <td>${product.id}</td>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>${formatCurrency(product.price)}</td>
                    <td>${product.stock}</td>
                    <td>${formatDate(product.expiryDate)}</td>
                    <td>
                        <span class="stock-badge ${stockBadgeClass}">${stockBadgeText}</span>
                        <span class="expiry-badge ${expiryBadgeClass}">${expiryBadgeText}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="editProduct('${product.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-delete" onclick="deleteProduct('${product.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                inventoryTableBody.appendChild(row);
            });
            
            inventoryTotalValueEl.textContent = formatCurrency(totalValue);
        });
        
        // Product buttons
        document.getElementById('add-product-btn').addEventListener('click', () => {
            openProductModal();
        });
        
        document.getElementById('add-inventory-btn').addEventListener('click', () => {
            openProductModal();
        });
        
        document.getElementById('save-product-btn').addEventListener('click', saveProduct);
        document.getElementById('cancel-product-btn').addEventListener('click', closeProductModal);
        
        // Cart buttons
        document.getElementById('clear-cart-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to clear the cart?')) {
                clearCart();
            }
        });
        
        document.getElementById('complete-sale-btn').addEventListener('click', completeSale);
        
        // Receipt modal buttons
        document.getElementById('print-receipt-btn').addEventListener('click', printReceipt);
        document.getElementById('new-sale-btn').addEventListener('click', () => {
            receiptModal.style.display = 'none';
        });
        
        // Report generation
        document.getElementById('generate-report-btn').addEventListener('click', generateReport);
        
        // Modal close buttons
        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('.modal').style.display = 'none';
            });
        });
        
        // Change password form
        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            
            if (newPassword !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }
            
            // Show loading state
            changePasswordBtn.classList.add('loading');
            changePasswordBtn.disabled = true;
            
            try {
                // Re-authenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email,
                    currentPassword
                );
                
                await auth.currentUser.reauthenticateWithCredential(credential);
                
                // Update password
                await auth.currentUser.updatePassword(newPassword);
                
                showNotification('Password changed successfully', 'success');
                document.getElementById('change-password-form').reset();
            } catch (error) {
                console.error('Error changing password:', error);
                showNotification('Failed to change password: ' + error.message, 'error');
            } finally {
                // Hide loading state
                changePasswordBtn.classList.remove('loading');
                changePasswordBtn.disabled = false;
            }
        });
        
        // Initialize app
        async function init() {
            // Load data from localStorage
            loadFromLocalStorage();
            loadSyncQueue();
            
            // Clean up any already synced operations
            cleanupSyncQueue();
            
            // Check auth state
            AuthModule.onAuthStateChanged(async (user) => {
                if (user) {
                    // Fetch user data from Firestore if needed
                    if (!currentUser || currentUser.uid !== user.uid) {
                        try {
                            const userDoc = await db.collection('users').doc(user.uid).get();
                            const userData = userDoc.data();
                            
                            if (userData) {
                                currentUser = {
                                    uid: user.uid,
                                    ...userData
                                };
                                localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                            }
                        } catch (error) {
                            console.error('Error fetching user data:', error);
                        }
                    }
                    
                    showApp();
                } else {
                    showLogin();
                }
            });
            
            // Set initial page
            showPage('pos');
            
            // Check online status
            if (isOnline) {
                checkFirebaseConnection();
            }
        }
        
        // Start the app
        init();
    </script>
</body>
</html>